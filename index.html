<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gem mini</title>
    <style>
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        a { text-decoration: none; color: white; }
        a:hover { text-decoration: none; color: rgba(255, 255, 255, 0.15); animation: fadeIn 0.5s ease; transition: opacity 0.3s ease, transform 0.3s ease;}

        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131314;
            color: white;
            display: flex;
            flex-direction: column;
            overflow-x: hidden; /* Prevent horizontal scroll when offcanvas is open */
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #131314;
            z-index: 100;
        }

        .menu-icon {
            cursor: pointer;
            padding: 0.5rem;
        }

        .menu-icon span {
            display: block;
            width: 20px;
            height: 2px;
            background: white;
            margin: 4px 0;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* Main Content */
        .main-content {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height:auto;
        }

        /* Welcome State */
        #welcomeText { text-align: center; }
        .welcome-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 80vh;
            padding: 0.5rem;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .welcome-state.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
            position: absolute;
            width: 100%;
        }

.scroll-to-top {
  z-index: 9999;
}
        .gemini-star {
            width: 48px;
            height: 48px;
            margin-bottom: 1.5rem;
        }

        .welcome-text {
            font-size: 1.5rem;
            color: rgba(255,255,255,0.8);
        }

        /* Chat State */
        .chat-container {
            flex: 1;
            padding: 1rem;
            display: none;
            flex-direction: column;
            gap: 1rem;
            animation: fadeIn 0.5s ease;
        }

        .chat-container.active {
            display: flex;
            max-width: 800px;
            width: 100%;
            padding: 10px;
            padding-top: 80px;
            padding-bottom: 10px;
            margin: auto;
            height: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* User Message */
        .user-message {
            align-self: flex-end;
            background: #3c4043;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            max-width: 80%;
            animation: slideInRight 0.4s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* AI Response */
        .ai-response {
            display: flex;
            flex-direction: column;
            padding: 0.75rem 1rem;
            gap: 0.5rem;
            animation: fadeInUp 0.5s ease 0.3s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-star {
            width: 24px;
            height: 24px;
        }

        .sound-icon {
            background: #131314;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .sound-icon:hover {
            opacity: 1;
        }

        .ai-text {
            font-size: 1rem;
            line-height: 1.5;
            white-space: pre-wrap; /* Ensure pre-formatted text wraps */
        }

        .ai-text pre {
            position: relative;
            background-color: #1e1f20;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1.5rem 1rem 1rem 1rem;
            margin-top: 0.5rem;
            overflow-x: hidden;
            white-space: pre-wrap;
            white-space: -moz-pre-wrap;
            white-space: -pre-wrap;
            white-space: -o-pre-wrap;
            word-wrap: break-word;
            font-family: 'Fira Code', 'Courier New', monospace;
        }

        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0.7;
            transition: opacity 0.2s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .copy-btn:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.15);
        }

        .copy-btn svg {
            fill: white;
        }

        /* Action Buttons for AI response */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
        }

        .action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.6;
            transition: opacity 0.2s, transform 0.2s;
        }

        .action-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .more-btn {
            margin-left: auto;
        }

        /* Disclaimer */
        .disclaimer {
            text-align: center;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            margin-top: 1rem;
        }

        /* Input Area */
        .input-area {
            max-width: 500px;
            width: 100%;
            margin: auto;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #131314;
            padding: 1rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-area.chat-mode-active { /* Changed class name to avoid conflict with chat-mode from previous snippet */
            background: #1e1f20;
            border-top-right-radius: 1.5rem;
            border-top-left-radius: 1.5rem;
        }

        .input-wrapper {
            background: #1e1f20;
            border-radius: 1.5rem;
            padding: 1rem 1.25rem;
            transition: all 0.3s ease;
        }

        .input-area.chat-mode-active .input-wrapper {
            background: transparent;
            padding: 0.5rem 0;
        }

        .input-field {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 1rem;
            outline: none;
            resize: none;
            height: 40px;
            line-height: 1.5;
        }

        input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .input-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.75rem;
            transition: all 0.3s ease;
        }

        .input-area.chat-mode-active .input-actions {
            margin-top: 0.5rem;
        }

        .left-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-icon {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .action-icon:hover {
            opacity: 1;
        }

        .right-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .cepat-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .cepat-btn:hover {
            background: rgba(255,255,255,0.15);
        }

        .mic-btn, .wave-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .mic-btn:hover, .wave-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .send-btn {
            background: #4285f4;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            transform: scale(1);
        }

        .send-btn.visible {
            opacity: 1;
            transform: scale(1);
        }

        .send-btn:hover {
            background: #5a95f5;
        }

        /* Typing Animation */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 0.5rem 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #4285f4;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
        }

        /* SVG Icons */
        svg {
            fill: white;
        }

        /* --- Custom Styles for Action Sheets and Offcanvas --- */

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Action Sheet Base */
        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 80%;
            background: #1e1f20;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            z-index: 300;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow-y: auto;
        }

        .action-sheet.active {
            transform: translateY(0);
        }

        .action-sheet-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
        }

        .action-sheet button {
            background: transparent;
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-sheet button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .action-sheet button.selected {
            background: #4285f4;
            font-weight: bold;
        }

        /* Offcanvas for Chat History */
        .offcanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 70%; /* Adjust as needed */
            max-width: 300px;
            height: 100%;
            background: #1e1f20;
            z-index: 300;
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .offcanvas.active {
            transform: translateX(0);
        }

        .offcanvas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .offcanvas-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .offcanvas-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }

        .offcanvas-content {
            flex: 1;
            overflow-y: auto;
        }

        .offcanvas-chat-item {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s ease;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .offcanvas-chat-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .history-title-span {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            pointer-events: none; /* Make clicks pass through to parent button */
        }

        .delete-chat-icon {
            margin-left: 1rem;
            padding: 0.2rem 0.5rem;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 1;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .delete-chat-icon:hover {
            background-color: rgba(255,255,255,0.2);
            opacity: 1;
            transform: scale(1.1);
        }

        button.new-chat-btn, #newChatBtn {
            background: #4285f4;
            margin-top: 1rem;
            font-weight: bold;
        }
        button.new-chat-btn:hover, #newChatBtn:hover {
            background: #5a95f5;
        }
        .offcanvas-content button.active-chat {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        .endpoint-url {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="menu-icon" id="chatHistoryBtn">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="logo" id="setting-status">Chat Mode</div>
        <a href="./usage"><div class="avatar">AI</div></a>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Welcome State -->
        <div class="welcome-state" id="welcomeState">
            <svg class="gemini-sparkle" viewBox="0 0 24 24" width="60" height="60">
                <defs>
                    <linearGradient id="sparkleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#4285f4"/>
                        <stop offset="100%" style="stop-color:#34a853"/>
                    </linearGradient>
                </defs>
                <path fill="url(#sparkleGradient)" d="M12 0L13.5 8.5L22 10L13.5 11.5L12 20L10.5 11.5L2 10L10.5 8.5L12 0Z"/>
                <path fill="url(#sparkleGradient)" d="M19 3L19.5 5.5L22 6L19.5 6.5L19 9L18.5 6.5L16 6L18.5 5.5L19 3Z"/>
                <path fill="url(#sparkleGradient)" d="M5 15L5.5 17L7 17.5L5.5 18L5 20L4.5 18L3 17.5L4.5 17L5 15Z"/>
            </svg>
            <p class="welcome-text" id="welcomeText">Apa yang bisa saya bantu?</p>
        </div>

        <!-- Chat Container -->
        <div class="chat-container" id="chatContainer"></div>
    </main>

    <!-- Input Area -->
    <div class="input-area" id="inputArea">
        <div class="input-wrapper">
            <div class="input-field">
                <input type="text" placeholder="Silahkan Minta Apapun" id="messageInput">
            </div>
            <div class="input-actions">
                <div class="left-actions">
                    <button class="action-icon" id="settingsBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24">
                            <path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/>
                        </svg>
                    </button>
                </div>
                <div class="right-actions">
                    <button class="cepat-btn" id="modelAiBtn">Deepseek</button>
                    <button class="send-btn" id="sendBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Model AI Action Sheet -->
    <div class="action-sheet" id="modelAiActionSheet">
        <div class="action-sheet-title">Pilih Model AI</div>
        <button data-model="@cf/meta/llama-3.1-8b-instruct-fp8">
            <span>llama-3</span>
            <span class="selected-indicator"></span>
        </button>
        <button data-model="@cf/qwen/qwen2.5-coder-32b-instruct">
            <span>qwen</span>
            <span class="selected-indicator"></span>
        </button>
        <button data-model="@cf/deepseek-ai/deepseek-r1-distill-qwen-32b">
            <span>deepseek</span>
            <span class="selected-indicator"></span>
        </button>
    </div>

    <!-- Settings (Chat Mode) Action Sheet -->
    <div class="action-sheet" id="settingsActionSheet">
        <div class="action-sheet-title">Pilih Mode Chat</div>
        <button data-mode="chat">
            <span>Chat</span>
            <span class="selected-indicator"></span>
        </button>
        <button data-mode="analyze-repo">
            <span>Analyze Repo</span>
            <span class="selected-indicator"></span>
        </button>
        <button data-mode="generate-code">
            <span>Generate Code</span>
            <span class="selected-indicator"></span>
        </button>
        <button data-mode="fix-error">
            <span>Fix Error</span>
            <span class="selected-indicator"></span>
        </button>
    </div>

    <!-- Chat History Offcanvas -->
    <div class="offcanvas" id="chatHistoryOffcanvas">
        <div class="offcanvas-header">
            <h3 class="offcanvas-title">Riwayat Chat</h3>
            <button class="offcanvas-close-btn" id="closeOffcanvasBtn">&times;</button>
        </div>
        <div class="offcanvas-content" id="offcanvasChatHistoryContent">
            <!-- Chat history items will be dynamically added here -->
            <p style="text-align: center; color: rgba(255,255,255,0.7);">Belum ada riwayat chat.</p>
        </div>
        <button class="btn new-chat-btn" id="newChatBtn">New Chat</button>
    </div>

    <!-- Load required libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.0/dist/purify.min.js"></script>

    <script>
        const welcomeTextEl = document.getElementById('welcomeText');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const welcomeState = document.getElementById('welcomeState');
        const chatContainer = document.getElementById('chatContainer');
        const mainContent = document.querySelector('.main-content');
        const inputArea = document.getElementById('inputArea');
        const settingStatus = document.getElementById('setting-status');

        const overlay = document.getElementById('overlay');
        const modelAiBtn = document.getElementById('modelAiBtn');
        const modelAiActionSheet = document.getElementById('modelAiActionSheet');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsActionSheet = document.getElementById('settingsActionSheet');
        const chatHistoryBtn = document.getElementById('chatHistoryBtn');
        const chatHistoryOffcanvas = document.getElementById('chatHistoryOffcanvas');
        const closeOffcanvasBtn = document.getElementById('closeOffcanvasBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const offcanvasChatHistoryContent = document.getElementById('offcanvasChatHistoryContent');

        const BACKEND_URL = 'https://daffa-ai.mvstream.workers.dev';

        // Global vars for chat history
        let allChats = [];
        let currentChatId = null;
        let currentChatTitle = "Obrolan";
        let currentMode = 'chat';
        let currentModel = '@cf/meta/llama-3.2-3b-instruct';

document.addEventListener('DOMContentLoaded', () => {
    loadAllChats();
    updateModelButtonText();
    updateSettingStatus();
    highlightSelectedOption(modelAiActionSheet, 'model', currentModel);
    highlightSelectedOption(settingsActionSheet, 'mode', currentMode);
    updateMessageInputPlaceholder();
    updateWelcomeText();
});
        
function updateWelcomeText() {
    let welcomeMessage = "Apa yang bisa saya bantu?";
    if (currentMode === 'analyze-repo') {
        welcomeMessage = "Berikan URL repo kamu untuk dianalisis! \n (e.g., https://github.com/owner/repo)";
    } else if (currentMode === 'generate-code') {
        welcomeMessage = "Berikan persyaratan kamu untuk generate kode!";
    } else if (currentMode === 'fix-error') {
        welcomeMessage = "\nCODE_START\n<kode Anda>\nCODE_END\nERROR_START\n<pesan error Anda>\nERROR_END";
    }
    welcomeTextEl.textContent = welcomeMessage;
}

        function generateUniqueId() {
            return 'chat-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
        }

        function loadAllChats() {
            const storedChats = localStorage.getItem('geminiChatHistory');
            if (storedChats) {
                allChats = JSON.parse(storedChats);
            } else {
                startNewChat();
                return;
            }

            const lastActiveChatId = localStorage.getItem('lastActiveChatId');
            if (lastActiveChatId && allChats.some(chat => chat.id === lastActiveChatId)) {
                loadChat(lastActiveChatId);
            } else if (allChats.length > 0) {
                loadChat(allChats[allChats.length - 1].id);
            } else {
                startNewChat();
            }
            renderChatHistoryList();
        }

        function saveAllChats() {
            localStorage.setItem('geminiChatHistory', JSON.stringify(allChats));
            if (currentChatId) {
                localStorage.setItem('lastActiveChatId', currentChatId);
            }
            renderChatHistoryList();
        }

        function findCurrentChat() {
            return allChats.find(chat => chat.id === currentChatId);
        }

        function startNewChat(mode = 'chat') {
            currentChatId = generateUniqueId();
            currentChatTitle = `Obrolan\n(${new Date().toLocaleString()})`;
            currentMode = mode;
            updateModelBasedOnMode();

            const newChat = {
                id: currentChatId,
                title: currentChatTitle,
                mode: currentMode,
                model: currentModel,
                messages: []
            };
            allChats.push(newChat);

            clearMainChatDisplay();
            updateSettingStatus();
            updateModelButtonText();
            updateMessageInputPlaceholder();
            updateWelcomeText();
            saveAllChats();
            closeOverlay();
        }

        function loadChat(chatId) {
            const chatToLoad = allChats.find(chat => chat.id === chatId);
            if (!chatToLoad) return;

            currentChatId = chatToLoad.id;
            currentChatTitle = chatToLoad.title;
            currentMode = chatToLoad.mode || 'chat';
            currentModel = chatToLoad.model || '@cf/meta/llama-3.2-3b-instruct';

            clearMainChatDisplay();
            chatToLoad.messages.forEach(msg => {
                if (msg.role === 'user') {
                    displayUserMessage(msg.content);
                } else if (msg.role === 'assistant') {
                    displayAIMessage(msg.content);
                }
            });

            const currentChat = findCurrentChat();
            if (currentChat) {
                currentChat.messages = chatToLoad.messages;
            }

            if (chatToLoad.messages.length > 0) {
                welcomeState.classList.add('hidden');
                chatContainer.classList.add('active');
                inputArea.classList.add('chat-mode-active');
                const lastMessageEl = chatContainer.lastElementChild;
                if (lastMessageEl) {
                    lastMessageEl.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
            } else {
                welcomeState.classList.remove('hidden');
                chatContainer.classList.remove('active');
                inputArea.classList.remove('chat-mode-active');
            }

            updateSettingStatus();
            updateModelButtonText();
            updateMessageInputPlaceholder();
            updateWelcomeText();
            saveAllChats();
            closeOverlay();
        }

        function clearMainChatDisplay() {
            chatContainer.innerHTML = '';
            welcomeState.classList.remove('hidden');
            chatContainer.classList.remove('active');
            inputArea.classList.remove('chat-mode-active');
        }

        function displayUserMessage(message) {
            const userMsgEl = document.createElement('div');
            userMsgEl.className = 'user-message';
            userMsgEl.textContent = message;
            chatContainer.appendChild(userMsgEl);
        }

        function displayAIMessage(message) {
            const aiResponseEl = document.createElement('div');
            aiResponseEl.className = 'ai-response';
            const renderedHtml = DOMPurify.sanitize(marked.parse(message));
            aiResponseEl.innerHTML = `
                <div class="ai-header">
                    <svg class="ai-star" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="starGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#4285f4"/>
                                <stop offset="100%" style="stop-color:#34a853"/>
                        </linearGradient>
                        </defs>
                        <path fill="url(#starGrad2)" d="M12 2L9.19 8.63L2 9.24L7.46 13.97L5.82 21L12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.63L12 2Z"/>
                    </svg>
                    <button class="sound-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    </button>
                </div>
                <div class="ai-text">${renderedHtml}</div>
                <div class="action-buttons">
                    <button class="action-btn"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/></svg></button>
                    <button class="action-btn"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg></button>
                    <button class="action-btn"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>
                    <button class="action-btn"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                    <button class="action-btn more-btn"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s-.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
                </div>
                <p class="disclaimer">AI dapat membuat kesalahan, jadi periksa kembali responsnya</p>
            `;
            chatContainer.appendChild(aiResponseEl);

            // Add copy buttons to code blocks
            aiResponseEl.querySelectorAll('pre').forEach(pre => {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
                pre.appendChild(copyBtn);

                copyBtn.addEventListener('click', () => {
                    const code = pre.querySelector('code');
                    if (navigator.clipboard && code) {
                        navigator.clipboard.writeText(code.textContent).then(() => {
                            copyBtn.textContent = '✓';
                            setTimeout(() => {
                                copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy text: ', err);
                        });
                    }
                });
            });
        }


        function renderChatHistoryList() {
            offcanvasChatHistoryContent.innerHTML = '';

            if (allChats.length === 0) {
                offcanvasChatHistoryContent.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">Belum ada riwayat chat.</p>';
                return;
            }

            [...allChats].reverse().forEach(chat => {
                const historyItem = document.createElement('button');
                historyItem.className = 'offcanvas-chat-item';
                if (chat.id === currentChatId) {
                    historyItem.classList.add('active-chat');
                }

                const titleSpan = document.createElement('span');
                titleSpan.className = 'history-title-span';
                titleSpan.textContent = chat.title;

                const deleteIcon = document.createElement('span');
                deleteIcon.className = 'delete-chat-icon';
                deleteIcon.innerHTML = '&times;';
                deleteIcon.dataset.chatId = chat.id;

                historyItem.appendChild(titleSpan);
                historyItem.appendChild(deleteIcon);

                historyItem.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-chat-icon')) {
                        e.stopPropagation();
                        handleDeleteChat(chat.id);
                    } else {
                        loadChat(chat.id);
                    }
                });
                offcanvasChatHistoryContent.appendChild(historyItem);
            });
        }

        function handleDeleteChat(chatIdToDelete) {
            if (!confirm('Apakah Anda yakin ingin menghapus percakapan ini?')) {
                return;
            }

            allChats = allChats.filter(chat => chat.id !== chatIdToDelete);

            if (currentChatId === chatIdToDelete) {
                currentChatId = null;
                if (allChats.length > 0) {
                    loadChat(allChats[allChats.length - 1].id);
                } else {
                    startNewChat();
                }
            } else {
                 saveAllChats(); 
            }
        }

        function updateModelButtonText() {
            let shortName = currentModel;

            if (currentModel.includes('meta/llama-3.2-3b-instruct')) {
                shortName = 'Llama 3-2';
            } else if (currentModel.includes('qwen2.5-coder-32b')) {
                shortName = 'Qwen';
            } else if (currentModel.includes('deepseek-r1-distill-qwen-32b')) {
                shortName = 'Deepseek';
            } else {
                shortName = currentModel.split('/').pop();
            }

            modelAiBtn.textContent = shortName;
        }

        function updateSettingStatus() {
            settingStatus.textContent = currentMode.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') + '';
        }

        function updateModelBasedOnMode() {
            switch(currentMode) {
                case 'chat':
                    currentModel = '@cf/meta/llama-3.2-3b-instruct';
                    break;
                case 'analyze-repo':
                case 'fix-error':
                    currentModel = '@cf/qwen/qwen2.5-coder-32b-instruct';
                    break;
                case 'generate-code':
                    currentModel = '@cf/deepseek-ai/deepseek-r1-distill-qwen-32b';
                    break;
                default:
                    currentModel = '@cf/meta/llama-3.2-3b-instruct';
            }
            updateModelButtonText();
            highlightSelectedOption(modelAiActionSheet, 'model', currentModel);
        }

        function highlightSelectedOption(container, type, value) {
            container.querySelectorAll(`button[data-${type}]`).forEach(button => {
                if (button.dataset[type] === value) {
                    button.classList.add('selected');
                    button.innerHTML = `<span>${button.textContent.replace('✓', '').trim()}</span><span class="selected-indicator">✓</span>`;
                } else {
                    button.classList.remove('selected');
                    button.innerHTML = `<span>${button.textContent.replace('✓', '').trim()}</span><span class="selected-indicator"></span>`;
                }
            });
        }

        function openOverlay() {
            overlay.classList.add('active');
        }

        function closeOverlay() {
            overlay.classList.remove('active');
            modelAiActionSheet.classList.remove('active');
            settingsActionSheet.classList.remove('active');
            chatHistoryOffcanvas.classList.remove('active');
        }

        overlay.addEventListener('click', closeOverlay);

        modelAiBtn.addEventListener('click', () => {
            const modelName = currentModel.includes('llama-3.2') ? 'Llama 3.2' :
                             currentModel.includes('qwen2.5-coder-32b') ? 'Qwen' :
                             currentModel.includes('deepseek-r1-distill-qwen-32b') ? 'Deepseek' :
                             currentModel.split('/').pop();
            const modeName = currentMode.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            alert(`Currently using ${modelName} model for ${modeName} mode. Model selection is now automatic based on the mode.`);
        });

        settingsBtn.addEventListener('click', () => {
            openOverlay();
            settingsActionSheet.classList.add('active');
            highlightSelectedOption(settingsActionSheet, 'mode', currentMode);
        });

        chatHistoryBtn.addEventListener('click', () => {
            openOverlay();
            renderChatHistoryList();
            chatHistoryOffcanvas.classList.add('active');
        });

        closeOffcanvasBtn.addEventListener('click', closeOverlay);

        newChatBtn.addEventListener('click', () => {
            startNewChat(currentMode);
        });

        settingsActionSheet.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', (e) => {
                const newMode = e.currentTarget.dataset.mode;
                if (newMode !== currentMode) {
                    currentMode = newMode;
                    startNewChat(newMode);
                }
                updateSettingStatus();
                updateModelBasedOnMode();
                highlightSelectedOption(settingsActionSheet, 'mode', currentMode);
                updateWelcomeText();
                closeOverlay();
            });
        });

        function updateMessageInputPlaceholder() {
            let placeholderText = "Silahkan Minta Apapun";
            if (currentMode === 'analyze-repo') {
                placeholderText = "Masukkan URL repo";
            } else if (currentMode === 'generate-code') {
                placeholderText = "Tuliskan persyaratan";
            } else if (currentMode === 'fix-error') {
                placeholderText = "Masukkan kode dan error dalam format";
            }
            messageInput.placeholder = placeholderText;
        }

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            const currentChat = findCurrentChat();
            if (!currentChat) {
                console.error("No active chat found.");
                return;
            }

            if (currentChat.messages.length === 0) {
                welcomeState.classList.add('hidden');
                chatContainer.classList.add('active');
                inputArea.classList.add('chat-mode-active');
            }

            displayUserMessage(message);
            currentChat.messages.push({ role: 'user', content: message });
            saveAllChats();

            messageInput.value = '';

            const typingEl = document.createElement('div');
            typingEl.className = 'ai-response';
            typingEl.innerHTML = `
                <div class="ai-header">
                    <svg class="gemini-sparkle" viewBox="0 0 24 24" width="24" height="24">
                        <defs>
                            <linearGradient id="sparkleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#4285f4"/>
                                <stop offset="100%" style="stop-color:#34a853"/>
                            </linearGradient>
                        </defs>
                        <path fill="url(#sparkleGradient)" d="M12 0L13.5 8.5L22 10L13.5 11.5L12 20L10.5 11.5L2 10L10.5 8.5L12 0Z"/>
                        <path fill="url(#sparkleGradient)" d="M19 3L19.5 5.5L22 6L19.5 6.5L19 9L18.5 6.5L16 6L18.5 5.5L19 3Z"/>
                        <path fill="url(#sparkleGradient)" d="M5 15L5.5 17L7 17.5L5.5 18L5 20L4.5 18L3 17.5L4.5 17L5 15Z"/>
                    </svg>
                </div>
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatContainer.appendChild(typingEl);
            typingEl.scrollIntoView({ behavior: 'smooth', block: 'end' });


            try {
                let requestBody = {};
                let endpoint = '';

                if (currentMode === 'chat') {
                    endpoint = '/chat';
                    requestBody = {
                        message: message,
                        context: currentChat.messages,
                        model: currentModel
                    };
                } else if (currentMode === 'analyze-repo') {
                    endpoint = '/analyze-repo';
                    requestBody = {
                        repoUrl: message,
                        model: currentModel
                    };
                } else if (currentMode === 'generate-code') {
                    endpoint = '/generate-code';
                    requestBody = {
                        requirements: message,
                        language: 'javascript',
                        model: currentModel
                    };
                } else if (currentMode === 'fix-error') {
                    endpoint = '/fix-error';
                    const codeMatch = message.match(/CODE_START\n([\s\S]*?)\nCODE_END/);
                    const errorMatch = message.match(/ERROR_START\n([\s\S]*?)\nERROR_END/);

                    if (!codeMatch || !errorMatch) {
                        throw new Error("Untuk mode 'Fix Error', harap sertakan kode dan error dalam format:\nCODE_START\n<kode Anda>\nCODE_END\nERROR_START\n<pesan error Anda>\nERROR_END");
                    }

                    requestBody = {
                        code: codeMatch[1],
                        error: errorMatch[1],
                        language: 'javascript',
                        model: currentModel
                    };
                }

                const response = await fetch(`${BACKEND_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Terjadi kesalahan pada backend.');
                }

                let aiResponseText = '';
                if (currentMode === 'chat') {
                    aiResponseText = data.response;
                } else if (currentMode === 'analyze-repo') {
                    aiResponseText = `**Analisis Repository:** ${data.repository.full_name}\n\n${data.analysis}`;
                } else if (currentMode === 'generate-code') {
                    if (data.code) {
                        const fullCodeResponse = data.code;
                        const codeBlockMatch = fullCodeResponse.match(/```(?:[a-zA-Z]+)?\n([\s\S]*?)\n```/);

                        if (codeBlockMatch) {
                            const extractedCode = codeBlockMatch[1];
                            const languageMatch = fullCodeResponse.match(/```([a-zA-Z]+)/);
                            const language = languageMatch ? languageMatch[1] : (data.language || 'javascript');

                            const codeBlockPattern = /```(?:[a-zA-Z]+)?\n[\s\S]*?\n```/;
                            const matchResult = fullCodeResponse.match(codeBlockPattern);
                            if (matchResult) {
                                const codeBlockEndIndex = fullCodeResponse.indexOf(matchResult[0]) + matchResult[0].length;
                                const remainingText = fullCodeResponse.substring(codeBlockEndIndex).trim();

                                aiResponseText = '**Kode Dihasilkan:**\n\n```' + language + '\n' + extractedCode + '\n```\n\n**Penjelasan:** ' + remainingText;
                            } else {
                                aiResponseText = fullCodeResponse;
                            }
                        } else {
                            aiResponseText = fullCodeResponse;
                        }
                    } else if (data.response) {
                        const fullResponse = data.response;
                        const codeBlockMatch = fullResponse.match(/```(?:[a-zA-Z]+)?\n([\s\S]*?)\n```/);

                        if (codeBlockMatch) {
                            const extractedCode = codeBlockMatch[1];
                            const languageMatch = fullResponse.match(/```([a-zA-Z]+)/);
                            const language = languageMatch ? languageMatch[1] : 'javascript';

                            const codeBlockPattern = /```(?:[a-zA-Z]+)?\n[\s\S]*?\n```/;
                            const matchResult = fullResponse.match(codeBlockPattern);
                            if (matchResult) {
                                const codeBlockEndIndex = fullResponse.indexOf(matchResult[0]) + matchResult[0].length;
                                const remainingText = fullResponse.substring(codeBlockEndIndex).trim();

                                aiResponseText = '**Kode Dihasilkan:**\n\n```' + language + '\n' + extractedCode + '\n```\n\n**Penjelasan:** ' + remainingText;
                            } else {
                                aiResponseText = fullResponse;
                            }
                        } else {
                            aiResponseText = fullResponse;
                        }
                    } else {
                        aiResponseText = 'Tidak ada kode yang dihasilkan.';
                    }
                } else if (currentMode === 'fix-error') {
                    aiResponseText = `**Kode Asli:**\n\n\
${data.language}
${data.original_code}
\
\n**Kode Diperbaiki:**\n\n\
${data.language}
${data.fixed_code}
\
\n**Penjelasan Perbaikan:** ${data.fixed_code_explanation || ''}\n\n**Tips Pencegahan:** ${data.prevention_tips || ''}`;
                } else {
                    aiResponseText = JSON.stringify(data, null, 2);
                }

                typingEl.remove();
                displayAIMessage(aiResponseText);
                currentChat.messages.push({ role: 'assistant', content: aiResponseText });
                saveAllChats();

                setTimeout(() => {
                    chatContainer.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 100);
            } catch (error) {
                console.error('Error sending message:', error);
                typingEl.remove();
                const errorText = `Error: ${error.message}`;
                displayAIMessage(errorText);
                currentChat.messages.push({ role: 'assistant', content: errorText });
                saveAllChats();

                setTimeout(() => {
                    chatContainer.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 100);
            }
        }
    </script>
</body>
</html>